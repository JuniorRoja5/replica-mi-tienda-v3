<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Digital Product</title>
    
    <!-- Bootstrap 5.3.0 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <!-- Responsive Fixes -->
    <link href="css/responsive-fixes.css" rel="stylesheet">
    
    <!-- Enhanced Visual Design -->
    <link href="css/enhanced-design.css" rel="stylesheet">
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 0;
        }

        .product-container {
            max-width: 600px;
            margin: 0 auto;
            min-height: 100vh;
            background: #1a1a1a;
            color: white;
            position: relative;
        }

        .header-bar {
            position: sticky;
            top: 0;
            background: rgba(26, 26, 26, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #333;
            z-index: 100;
            padding: 1rem;
        }

        .back-button {
            background: none;
            border: none;
            color: #a0a0a0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.95rem;
            transition: color 0.2s ease;
            text-decoration: none;
        }

        .back-button:hover {
            color: white;
        }

        .product-content {
            padding: 2rem 1.5rem;
            padding-bottom: 120px; /* Space for fixed purchase button */
        }

        .product-image {
            width: 100%;
            height: 250px;
            border-radius: 1rem;
            object-fit: cover;
            margin-bottom: 2rem;
            background: #2a2a2a;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .product-image-placeholder {
            color: #666;
            font-size: 3rem;
        }

        .product-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            line-height: 1.2;
        }

        .product-subtitle {
            font-size: 1.1rem;
            color: #a0a0a0;
            margin-bottom: 1.5rem;
            line-height: 1.4;
        }

        .price-section {
            margin-bottom: 2rem;
        }

        .current-price {
            font-size: 2.5rem;
            font-weight: 700;
            color: #10b981;
            display: inline-block;
        }

        .original-price {
            font-size: 1.2rem;
            color: #666;
            text-decoration: line-through;
            margin-left: 1rem;
            vertical-align: top;
            margin-top: 0.5rem;
            display: inline-block;
        }

        .discount-badge {
            background: #dc2626;
            color: white;
            font-size: 0.85rem;
            padding: 0.25rem 0.75rem;
            border-radius: 2rem;
            font-weight: 600;
            margin-left: 1rem;
            vertical-align: top;
            margin-top: 0.75rem;
            display: inline-block;
        }

        .product-description {
            line-height: 1.6;
            color: #d0d0d0;
            margin-bottom: 2rem;
            white-space: pre-line;
        }

        .reviews-section {
            margin-bottom: 2rem;
        }

        .reviews-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .review-item {
            background: #2a2a2a;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .review-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .review-name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .review-stars {
            color: #fbbf24;
            font-size: 0.85rem;
        }

        .review-comment {
            color: #a0a0a0;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .purchase-section {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            max-width: 600px;
            width: 100%;
            background: rgba(26, 26, 26, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid #333;
            padding: 1.5rem;
            z-index: 100;
        }

        .purchase-button {
            width: 100%;
            background: #8b5cf6;
            border: none;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            padding: 1rem;
            border-radius: 0.75rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .purchase-button:hover {
            background: #7c3aed;
            transform: translateY(-2px);
        }

        .purchase-button:active {
            transform: translateY(0);
        }

        .error-container, .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 100vh;
            padding: 2rem;
        }

        .error-icon, .loading-spinner {
            font-size: 4rem;
            color: #666;
            margin-bottom: 1rem;
        }

        .loading-spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .error-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .error-message {
            color: #a0a0a0;
            margin-bottom: 1.5rem;
        }

        .error-button {
            background: #8b5cf6;
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background 0.2s ease;
        }

        .error-button:hover {
            background: #7c3aed;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .product-content {
                padding: 1.5rem 1rem;
                padding-bottom: 120px;
            }
            
            .product-title {
                font-size: 1.75rem;
            }
            
            .current-price {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Loading State -->
    <div id="loadingState" class="loading-container">
        <div class="loading-spinner">
            <i class="bi bi-arrow-clockwise"></i>
        </div>
        <h2>Loading product...</h2>
        <p style="color: #a0a0a0;">Please wait</p>
    </div>

    <!-- Error State -->
    <div id="errorState" class="error-container" style="display: none;">
        <div class="error-icon">
            <i class="bi bi-exclamation-triangle"></i>
        </div>
        <h2 class="error-title">Product not found</h2>
        <p class="error-message">This product doesn't exist or is not available.</p>
        <button class="error-button" onclick="goBack()">
            <i class="bi bi-arrow-left"></i> Back
        </button>
    </div>

    <!-- Main Product Content -->
    <div id="productContainer" class="product-container" style="display: none;">
        <!-- Header -->
        <div class="header-bar">
            <a href="#" class="back-button" id="backButton">
                <i class="bi bi-arrow-left"></i>
                <span>Back to profile</span>
            </a>
        </div>

        <!-- Product Content -->
        <div class="product-content">
            <!-- Product Image -->
            <div id="productImageContainer">
                <div class="product-image" id="productImage">
                    <div class="product-image-placeholder">
                        <i class="bi bi-box-seam"></i>
                    </div>
                </div>
            </div>

            <!-- Product Info -->
            <div class="product-info">
                <h1 class="product-title" id="productTitle">T√≠tulo del Producto</h1>
                <p class="product-subtitle" id="productSubtitle" style="display: none;">Subt√≠tulo del producto</p>
                
                <!-- Price Section -->
                <div class="price-section" id="priceSection" style="display: none;">
                    <span class="current-price" id="currentPrice">$0</span>
                    <span class="original-price" id="originalPrice" style="display: none;">$0</span>
                    <span class="discount-badge" id="discountBadge" style="display: none;">¬°Oferta!</span>
                </div>

                <!-- Description -->
                <div class="product-description" id="productDescription">
                    Descripci√≥n del producto...
                </div>

                <!-- Reviews -->
                <div class="reviews-section" id="reviewsSection" style="display: none;">
                    <h3 class="reviews-title">
                        <i class="bi bi-star-fill" style="color: #fbbf24;"></i>
                        Rese√±as de clientes
                    </h3>
                    <div id="reviewsList"></div>
                </div>
            </div>
        </div>

        <!-- Purchase Section -->
        <div class="purchase-section">
            <button class="purchase-button" id="purchaseButton" onclick="handlePurchase()">
                <i class="bi bi-cart-plus"></i>
                <span id="purchaseButtonText">Comprar ahora</span>
            </button>
        </div>
    </div>

    <!-- Bootstrap 5.3.0 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Product data (will be loaded from localStorage or URL params)
        let productData = null;
        let profileData = null;

        // Load product on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadProductData();
        });

        function loadProductData() {
            try {
                // Get product ID from URL parameters (supports 'p' for product, 'c' for consultation, 'course' for course, 'membership' for membership)
                const urlParams = new URLSearchParams(window.location.search);
                const productId = urlParams.get('p') || urlParams.get('c') || urlParams.get('course') || urlParams.get('membership');
                const isConsultation = !!urlParams.get('c');
                const isCourse = !!urlParams.get('course');
                const isMembership = !!urlParams.get('membership');
                const username = urlParams.get('u');
                const isPreview = urlParams.get('preview') === 'true';

                const productType = isConsultation ? 'consultation' : (isCourse ? 'course' : (isMembership ? 'membership' : 'product'));
                console.log('Loading', productType, ':', productId, 'for user:', username, 'preview:', isPreview);

                if (!productId) {
                    showError('Par√°metros de URL inv√°lidos');
                    return;
                }

                // If it's a preview, try to load from temporary storage first
                let appData = null;
                if (isPreview) {
                    const tempData = localStorage.getItem('tempProductPreview');
                    if (tempData) {
                        appData = JSON.parse(tempData);
                        console.log('Loading from temporary preview data');
                    }
                }

                // If no preview data or not preview mode, load from main storage
                if (!appData) {
                    const storedData = localStorage.getItem('miTiendaData');
                    if (!storedData) {
                        showError('Datos no encontrados');
                        return;
                    }
                    appData = JSON.parse(storedData);
                    console.log('Loading from main storage');
                }

                profileData = appData.profile;

                // Find the product - convert both to string for comparison
                const product = appData.products.find(p => p.id.toString() === productId.toString());
                if (!product) {
                    console.log('Product/Consultation/Course not found. Available products:', appData.products.map(p => ({id: p.id, title: p.title, type: p.type})));
                    const errorMessage = isConsultation ? 'Consultor√≠a no encontrada' : (isCourse ? 'Curso no encontrado' : 'Producto no encontrado');
                    showError(errorMessage);
                    return;
                }

                // Verify product type matches URL parameter
                if (isConsultation && product.type !== 'consultation') {
                    console.log('URL expects consultation but product type is:', product.type);
                    showError('Tipo de producto incorrecto');
                    return;
                } else if (isCourse && product.type !== 'course') {
                    console.log('URL expects course but product type is:', product.type);
                    showError('Tipo de producto incorrecto');
                    return;
                } else if (!isConsultation && !isCourse && (product.type === 'consultation' || product.type === 'course')) {
                    console.log('URL expects product but found:', product.type);
                    showError('Tipo de producto incorrecto');
                    return;
                }

                console.log(productType + ' found:', product);
                productData = product;
                displayProduct();

            } catch (error) {
                console.error('Error loading product:', error);
                showError('Error cargando el producto');
            }
        }

        function displayProduct() {
            if (!productData) return;

            // Hide loading, show product
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('productContainer').style.display = 'block';

            // Set page title
            let pageTitle = productData.title;
            if (productData.type === 'consultation') {
                pageTitle += ' - Consultor√≠a';
            } else if (productData.type === 'course') {
                pageTitle += ' - Curso Digital';
            } else if (productData.type === 'membership') {
                pageTitle += ' - Membres√≠a';
            }
            document.getElementById('pageTitle').textContent = pageTitle;
            document.title = pageTitle;

            // Back button
            const username = profileData.username || 'user';
            document.getElementById('backButton').href = `mi-tienda.html?preview=true&u=${username}`;

            // Product image
            if (productData.image_url) {
                document.getElementById('productImage').innerHTML = `
                    <img src="${productData.image_url}" alt="${productData.title}" class="product-image">
                `;
            }

            // Product title and subtitle
            document.getElementById('productTitle').textContent = productData.title;
            
            if (productData.subtitle) {
                document.getElementById('productSubtitle').textContent = productData.subtitle;
                document.getElementById('productSubtitle').style.display = 'block';
            }

            // Price section
            if (productData.price && productData.price > 0) {
                const priceSection = document.getElementById('priceSection');
                const currentPriceEl = document.getElementById('currentPrice');
                const originalPriceEl = document.getElementById('originalPrice');
                const discountBadge = document.getElementById('discountBadge');

                let frequencyText = '';
                if (productData.type === 'membership' && productData.billing_settings) {
                    const frequencies = {
                        'daily': ' / d√≠a',
                        'weekly': ' / semana', 
                        'monthly': ' / mes',
                        'quarterly': ' / trimestre',
                        'semi_annually': ' / semestre',
                        'annually': ' / a√±o'
                    };
                    frequencyText = frequencies[productData.billing_settings.frequency] || ' / mes';
                }

                if (productData.has_discount && productData.discount_price > 0) {
                    // Show discounted price
                    currentPriceEl.textContent = `$${productData.discount_price}${frequencyText}`;
                    originalPriceEl.textContent = `$${productData.price}${frequencyText}`;
                    originalPriceEl.style.display = 'inline-block';
                    
                    // Calculate discount percentage
                    const discountPercent = Math.round(((productData.price - productData.discount_price) / productData.price) * 100);
                    discountBadge.textContent = `-${discountPercent}%`;
                    discountBadge.style.display = 'inline-block';
                } else {
                    // Show regular price
                    currentPriceEl.textContent = `$${productData.price}${frequencyText}`;
                }

                priceSection.style.display = 'block';
            }

            // Description
            document.getElementById('productDescription').textContent = productData.description || 'Sin descripci√≥n disponible.';

            // Reviews
            if (productData.reviews && productData.reviews.length > 0) {
                displayReviews(productData.reviews);
            }

            // Purchase button
            const purchaseBtn = document.getElementById('purchaseButtonText');
            const purchaseButton = document.getElementById('purchaseButton');
            
            if (productData.type === 'consultation') {
                // For consultations, update button text and icon
                if (productData.button_text) {
                    purchaseBtn.textContent = productData.button_text;
                } else {
                    purchaseBtn.textContent = 'Agendar llamada';
                }
                purchaseButton.innerHTML = `
                    <i class="bi bi-calendar-plus"></i>
                    <span id="purchaseButtonText">${purchaseBtn.textContent}</span>
                `;
            } else if (productData.type === 'course') {
                // For courses, update button text and icon
                if (productData.button_text) {
                    purchaseBtn.textContent = productData.button_text;
                } else {
                    purchaseBtn.textContent = 'Empezar curso';
                }
                purchaseButton.innerHTML = `
                    <i class="bi bi-play-circle"></i>
                    <span id="purchaseButtonText">${purchaseBtn.textContent}</span>
                `;
            } else if (productData.type === 'membership') {
                // For memberships, update button text and icon
                if (productData.button_text) {
                    purchaseBtn.textContent = productData.button_text;
                } else if (productData.price > 0) {
                    const displayPrice = productData.has_discount && productData.discount_price > 0 
                        ? productData.discount_price 
                        : productData.price;
                    
                    // Get frequency text
                    const getFrequencyText = (frequency) => {
                        const frequencies = {
                            'daily': 'd√≠a',
                            'weekly': 'semana', 
                            'monthly': 'mes',
                            'quarterly': 'trimestre',
                            'semi_annually': 'semestre',
                            'annually': 'a√±o'
                        };
                        return frequencies[frequency] || 'mes';
                    };
                    
                    const frequencyText = productData.billing_settings ? 
                        getFrequencyText(productData.billing_settings.frequency) : 'mes';
                    
                    purchaseBtn.textContent = `Subscribirse por $${displayPrice}/${frequencyText}`;
                } else {
                    purchaseBtn.textContent = 'Subscribirse Gratis';
                }
                purchaseButton.innerHTML = `
                    <i class="bi bi-crown"></i>
                    <span id="purchaseButtonText">${purchaseBtn.textContent}</span>
                `;
            } else {
                // For regular products
                if (productData.button_text) {
                    purchaseBtn.textContent = productData.button_text;
                } else if (productData.price > 0) {
                    const displayPrice = productData.has_discount && productData.discount_price > 0 
                        ? productData.discount_price 
                        : productData.price;
                    purchaseBtn.textContent = `Comprar por $${displayPrice}`;
                } else {
                    purchaseBtn.textContent = 'Obtener Gratis';
                }
                purchaseButton.innerHTML = `
                    <i class="bi bi-cart-plus"></i>
                    <span id="purchaseButtonText">${purchaseBtn.textContent}</span>
                `;
            }
        }

        function displayReviews(reviews) {
            const validReviews = reviews.filter(review => 
                review.customer_name && review.customer_name.trim() !== '' && 
                review.comment && review.comment.trim() !== ''
            );

            if (validReviews.length === 0) return;

            document.getElementById('reviewsSection').style.display = 'block';
            
            const reviewsList = document.getElementById('reviewsList');
            reviewsList.innerHTML = validReviews.map(review => {
                const stars = Array.from({length: 5}, (_, i) => 
                    `<i class="bi bi-star${i < review.rating ? '-fill' : ''}"></i>`
                ).join('');

                return `
                    <div class="review-item">
                        <div class="review-header">
                            <span class="review-name">${review.customer_name}</span>
                            <div class="review-stars">${stars}</div>
                        </div>
                        <p class="review-comment">${review.comment}</p>
                    </div>
                `;
            }).join('');
        }

        function handlePurchase() {
            // TODO: Laravel Backend Integration
            // En producci√≥n, esto abrir√° diferentes modales seg√∫n el tipo de producto
            
            if (productData) {
                if (productData.type === 'consultation') {
                    // Para consultor√≠a, mostrar sistema de agendamiento
                    const consultationInfo = `üìÖ FUNCIONALIDAD DE AGENDAMIENTO
                    
Consultor√≠a: ${productData.title}
${productData.price > 0 ? `Precio: $${productData.price}` : 'Consultor√≠a gratuita'}
                    
üîß EN DESARROLLO:
‚úÖ Calendario interactivo de disponibilidad
‚úÖ Selecci√≥n de horarios disponibles
‚úÖ Formulario de datos del cliente
‚úÖ Confirmaci√≥n por email
‚úÖ Integraci√≥n con Google Meet/Zoom
‚úÖ Sistema de recordatorios

üìã INTEGRACI√ìN LARAVEL:
‚Ä¢ GET /api/consultations/{id}/availability
‚Ä¢ POST /api/bookings/create
‚Ä¢ POST /api/bookings/{id}/confirm  
‚Ä¢ Webhook: Integraci√≥n con calendario
‚Ä¢ Email: Confirmaci√≥n y recordatorios

Esta funcionalidad incluir√° el sistema de agendamiento
completo basado en la configuraci√≥n de disponibilidad.`;

                    alert(consultationInfo);
                } else if (productData.type === 'course') {
                    // Para cursos, mostrar sistema de inscripci√≥n/acceso
                    const courseInfo = `üéì FUNCIONALIDAD DE CURSO DIGITAL
                    
Curso: ${productData.title}
${productData.price > 0 ? `Precio: $${productData.price}` : 'Curso gratuito'}
                    
üîß EN DESARROLLO:
‚úÖ Plataforma de aprendizaje integrada
‚úÖ Reproducci√≥n de videos por m√≥dulos
‚úÖ Progreso de lecciones 
‚úÖ Descarga de materiales
‚úÖ Certificado de finalizaci√≥n
‚úÖ Acceso de por vida/limitado

üìã INTEGRACI√ìN LARAVEL:
‚Ä¢ POST /api/courses/{id}/enroll
‚Ä¢ GET /api/courses/{id}/content
‚Ä¢ POST /api/courses/{id}/progress
‚Ä¢ POST /api/courses/{id}/complete
‚Ä¢ Email: Acceso al curso y certificado

Esta funcionalidad incluir√° la plataforma de aprendizaje
completa con seguimiento de progreso y contenido multimedia.`;

                    alert(courseInfo);
                } else {
                    // Para productos digitales, sistema de compras
                    const displayPrice = productData.has_discount && productData.discount_price > 0 
                        ? productData.discount_price 
                        : productData.price;
                    
                    const purchaseInfo = `üõí FUNCIONALIDAD DE COMPRA
                    
Producto: ${productData.title}
Precio: $${displayPrice}
                    
üîß EN DESARROLLO:
‚úÖ Modal de compra embebido (como en mi-tienda.html)
‚úÖ Integraci√≥n con Stripe Elements
‚úÖ Procesamiento de pagos seguro
‚úÖ Animaci√≥n de confeti de √©xito
‚úÖ Entrega autom√°tica por email

üìã INTEGRACI√ìN LARAVEL:
‚Ä¢ POST /api/stripe/create-payment-intent
‚Ä¢ POST /api/orders/create  
‚Ä¢ Webhook: /api/stripe/webhook
‚Ä¢ POST /api/orders/deliver

Esta p√°gina individual ser√° integrada con el mismo
sistema de compras de la p√°gina principal.`;

                    alert(purchaseInfo);
                }
                
                // TODO: Redirigir o abrir modal espec√≠fico seg√∫n tipo
                // window.opener.showPurchaseModal(productData);
                // window.opener.showBookingCalendar(productData);
                // window.opener.showCourseEnrollment(productData);
            }
        }

        function showError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('productContainer').style.display = 'none';
            document.getElementById('errorState').style.display = 'flex';
            
            const errorMessage = document.querySelector('#errorState .error-message');
            if (errorMessage) {
                errorMessage.textContent = message;
            }
        }

        function goBack() {
            if (window.history.length > 1) {
                window.history.back();
            } else {
                window.location.href = 'mi-tienda.html';
            }
        }
    </script>
</body>
</html>